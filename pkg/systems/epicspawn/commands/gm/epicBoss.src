use uo;
use os;
use polsys;
use util;

include "include/client";
include "include/say";
include ":gumps:include/epicGumps";
include ":epicspawn:epicBoss";

// Constants for button IDs and menu pages
const BOTAO_PAGE1 := 1;
const BOTAO_PAGE2 := 2;
const BOTAO_PAGE3 := 3;
const BOTAO_PAGE4 := 4;
const BOTAO_PAGE5 := 5;

const MENU_PAGE1 := 1;
const MENU_PAGE2 := 2;
const MENU_PAGE3 := 3;
const MENU_PAGE4 := 4;
const MENU_PAGE5 := 5;

// Track which button was last clicked
var button_states := array{1, 0, 0, 0, 0};
var last_clicked_button := BOTAO_PAGE1;

// Global storage for form data
var form_data := struct{};

program epicBOSS(who)
    // Create a gump with title "EPIC BOSS"
    var gump_width := 1200;
    var gump_height := 800;
    var title := "EPIC BOSS";
    
    // Initialize form data
    InitializeFormData();
    
    // Show the first page initially
    var input := ShowPage1(who, title, gump_width, gump_height);
    
    // Process user input until they close the gump
    while (input[0] != 0)
        // Save form data from the current page
        SaveFormData(input);
        
        // Check if the Create Boss button was clicked
        if (input[0] == 100)
            SendSysMessage(who, "Creating boss...");
            CreateBossFromGump(who, form_data);
            break; // Exit after creating the boss
        endif
        
        var new_menu := UpdateMenuState(input[0], who);
        case (new_menu)
            MENU_PAGE1: 
                input := ShowPage1(who, title, gump_width, gump_height);
            MENU_PAGE2: 
                input := ShowPage2(who, title, gump_width, gump_height);
            MENU_PAGE3:
                input := ShowPage3(who, title, gump_width, gump_height);
            MENU_PAGE4: 
                input := ShowPage4(who, title, gump_width, gump_height);
            MENU_PAGE5:
                input := ShowPage5(who, title, gump_width, gump_height);
        endcase
    endwhile
    
    return 1;
endprogram

// Initialize the form data structure with default values
function InitializeFormData()
    // Basic info
    form_data.npctemplate := "goblin";
    form_data.name := "";
    form_data.color := "0";
    form_data.description := "";
    form_data.trueboss := 0;
    form_data.special_ai := "";
    form_data.url := "";
    form_data.detailed_description := "";
    
    // Attributes
    form_data.str := "0";
    form_data.dex := "0";
    form_data.int := "0";
    form_data.hits := "0";
    form_data.dmg := "0";
    
    // Resistances
    form_data.phresist := "0";
    form_data.firesist := "0";
    form_data.coresist := "0";
    form_data.enresist := "0";
    form_data.poresist := "0";
    
    // Skills
    form_data.wrestling := "0";
    form_data.tactics := "0";
    form_data.magery := "0";
    form_data.awareness := "0";
    
    // Behavior
    form_data.teleport_health := "25";
    form_data.aggression := "High";
    form_data.flee_health := "10";
    form_data.target_selection := "Highest Damage";
    
    // Equipment
    form_data.weapon_type := "";
    form_data.specific_weapon := "";
    form_data.class := "";
    form_data.magic_school := "";
    form_data.drop_chance := "25";
    
    // Special abilities, loot, and death events will be initialized as needed
    form_data.special := array{};
    form_data.loot := array{};
    form_data.deathevent := array{};
    
    // Patrol and teleport locations
    form_data.patrol_loc1 := struct{};
    form_data.patrol_loc2 := struct{};
    form_data.teleport_loc := struct{};
endfunction

// Save form data from the current page
function SaveFormData(input)
    // Check which page we're on based on the last clicked button
    case (last_clicked_button)
        BOTAO_PAGE1:
            // Basic info
            if (input[1])
                form_data.npctemplate := GFExtractData(input, 1);
            endif
            if (input[2])
                form_data.name := GFExtractData(input, 2);
            endif
            if (input[3])
                form_data.color := GFExtractData(input, 3);
            endif
            if (input[4])
                form_data.description := GFExtractData(input, 4);
            endif
            form_data.trueboss := input[5];
            if (input[6])
                form_data.special_ai := GFExtractData(input, 6);
            endif
            if (input[7])
                form_data.url := GFExtractData(input, 7);
            endif
            if (input[8])
                form_data.detailed_description := GFExtractData(input, 8);
            endif
            break;
            
        BOTAO_PAGE2:
            // Attributes
            if (input[10])
                form_data.str := GFExtractData(input, 10);
            endif
            if (input[11])
                form_data.dex := GFExtractData(input, 11);
            endif
            if (input[12])
                form_data.int := GFExtractData(input, 12);
            endif
            if (input[13])
                form_data.hits := GFExtractData(input, 13);
            endif
            if (input[14])
                form_data.dmg := GFExtractData(input, 14);
            endif
            
            // Resistances
            if (input[15])
                form_data.phresist := GFExtractData(input, 15);
            endif
            if (input[16])
                form_data.firesist := GFExtractData(input, 16);
            endif
            if (input[17])
                form_data.coresist := GFExtractData(input, 17);
            endif
            if (input[18])
                form_data.enresist := GFExtractData(input, 18);
            endif
            if (input[19])
                form_data.poresist := GFExtractData(input, 19);
            endif
            
            // Skills
            if (input[20])
                form_data.wrestling := GFExtractData(input, 20);
            endif
            if (input[21])
                form_data.tactics := GFExtractData(input, 21);
            endif
            if (input[22])
                form_data.magery := GFExtractData(input, 22);
            endif
            if (input[23])
                form_data.awareness := GFExtractData(input, 23);
            endif
            break;
            
        BOTAO_PAGE3:
            // Special abilities
            // These would be handled by specific buttons on page 3
            // For now, we'll just save any button clicks for future implementation
            if (input[30])
                // Add Special Ability button
                // This would typically open a sub-gump to select an ability
            endif
            
            if (input[40])
                // Add Combat Event button
                // This would typically open a sub-gump to configure a combat event
            endif
            
            if (input[50])
                // Add TimedScript button
                // This would typically open a sub-gump to select a timed script
            endif
            
            if (input[60])
                // Add Death Event button
                // This would typically open a sub-gump to configure a death event
            endif
            break;
            
        BOTAO_PAGE4:
            // Behavior
            if (input[70])
                // Set Patrol Location 1 button
                // This would typically store the player's current location
            endif
            
            if (input[71])
                // Set Patrol Location 2 button
                // This would typically store the player's current location
            endif
            
            if (input[72])
                form_data.teleport_health := GFExtractData(input, 72);
            endif
            
            if (input[73])
                // Set Teleport Location button
                // This would typically store the player's current location
            endif
            
            if (input[74])
                // Add Ability Condition button
                // This would typically open a sub-gump to configure a condition
            endif
            
            if (input[75])
                // Aggression Level button
                // This would typically cycle through different aggression levels
                form_data.aggression := "High"; // Default for now
            endif
            
            if (input[76])
                form_data.flee_health := GFExtractData(input, 76);
            endif
            
            if (input[77])
                // Target Selection button
                // This would typically cycle through different target selection methods
                form_data.target_selection := "Highest Damage"; // Default for now
            endif
            break;
            
        BOTAO_PAGE5:
            // Equipment
            // Weapon type radio buttons
            if (input[80])
                form_data.weapon_type := "Dual Wield";
            endif
            
            if (input[81])
                form_data.weapon_type := "One-Handed";
            endif
            
            if (input[82])
                form_data.weapon_type := "Two-Handed";
            endif
            
            if (input[83])
                form_data.weapon_type := "Ranged";
            endif
            
            if (input[84])
                form_data.specific_weapon := GFExtractData(input, 84);
            endif
            
            // Class type radio buttons
            if (input[85])
                form_data.class := "Warrior";
            endif
            
            if (input[86])
                form_data.class := "Mage";
            endif
            
            if (input[87])
                form_data.class := "Ranger";
            endif
            
            if (input[88])
                form_data.magic_school := GFExtractData(input, 88);
            endif
            
            if (input[90])
                // Add Loot Item button
                // This would typically open a sub-gump to select a loot item
            endif
            
            if (input[91])
                form_data.drop_chance := GFExtractData(input, 91);
            endif
            break;
    endcase
endfunction

// Function to update which menu is active based on button click
function UpdateMenuState(input, who)
    last_clicked_button := input;
    
    // Inform the user that their data is being saved
    case (input)
        BOTAO_PAGE1:
            button_states := array{1, 0, 0, 0, 0};
            SendSysMessage(who, "Switching to Basic Info page. Your data has been saved.");
            return MENU_PAGE1;
        BOTAO_PAGE2:
            button_states := array{0, 1, 0, 0, 0};
            SendSysMessage(who, "Switching to Attributes page. Your data has been saved.");
            return MENU_PAGE2;
        BOTAO_PAGE3:
            button_states := array{0, 0, 1, 0, 0};
            SendSysMessage(who, "Switching to Abilities page. Your data has been saved.");
            return MENU_PAGE3;
        BOTAO_PAGE4:
            button_states := array{0, 0, 0, 1, 0};
            SendSysMessage(who, "Switching to Behavior page. Your data has been saved.");
            return MENU_PAGE4;
        BOTAO_PAGE5:
            button_states := array{0, 0, 0, 0, 1};
            SendSysMessage(who, "Switching to Equipment page. Your data has been saved.");
            return MENU_PAGE5;
    endcase

    // Default to page 1 if no valid input
    button_states := array{1, 0, 0, 0, 0};
    SendSysMessage(who, "Switching to Basic Info page. Your data has been saved.");
    return MENU_PAGE1;
endfunction

// Function to add navigation buttons at the top of the gump
function AddNavigationButtons(byref gump, gump_width)
    var titles := array{
        "BASIC INFO",      // Basic boss information
        "ATTRIBUTES",      // Stats, skills, resistances
        "ABILITIES",       // Special abilities and combat events
        "BEHAVIOR",        // Patrol areas, conditions, AI settings
        "EQUIPMENT"        // Weapons, armor, and loot
    };
    var x_positions := array{150, 350, 550, 750, 950};
    var buttons := array{BOTAO_PAGE1, BOTAO_PAGE2, BOTAO_PAGE3, BOTAO_PAGE4, BOTAO_PAGE5};
    
    // Create a background for the navigation bar
    GFResizePic(gump, 45, 80, 9350, gump_width - 90, 40);
    
    // Add each button with appropriate styling
    for i := 1 to titles.size()
        var gump_button := 2151; // Normal button
        var text_color := 53;    // Normal text color
        
        if (buttons[i] == last_clicked_button)
            gump_button := 2153; // Active button
            text_color := 230;   // Active text color
        endif
        
        // Add the text and button
        GFTextLine(gump, x_positions[i], 90, text_color, titles[i]);
        GFAddButton(gump, x_positions[i] - 35, 85, gump_button, gump_button, 1, buttons[i]);
    endfor
endfunction

// Functions for each page
function ShowPage1(who, title, gump_width, gump_height)
    var gump := GFECreateGump(title, gump_width, gump_height);
    
    // Add navigation buttons
    AddNavigationButtons(gump, gump_width);
    
    // Page 1 content - BASIC INFO
    GFTextMid(gump, 0, 150, gump_width, 1153, "BASIC INFORMATION");
    
    // NPC Template selection
    GFTextLine(gump, 50, 200, 1153, "NPC Template:");
    GFTextEntry(gump, 200, 200, 300, 20, 1150, form_data.npctemplate, 1);
    GFTextLine(gump, 200, 220, 2100, "(No need to specify :brainAI: or :epicAI: prefix)");
    
    // Boss Name
    GFTextLine(gump, 50, 250, 1153, "Boss Name:");
    GFTextEntry(gump, 200, 250, 300, 20, 1150, form_data.name, 2);
    
    // Color
    GFTextLine(gump, 50, 280, 1153, "Color:");
    GFTextEntry(gump, 200, 280, 100, 20, 1150, form_data.color, 3);
    
    // Description
    GFTextLine(gump, 50, 310, 1153, "Description:");
    GFTextEntry(gump, 200, 310, 400, 60, 1150, form_data.description, 4);
    
    // True Boss checkbox
    GFCheckBox(gump, 50, 380, 2510, 2511, form_data.trueboss, 5);
    GFTextLine(gump, 80, 380, 1153, "True Boss");
    
    // Special AI
    GFTextLine(gump, 50, 410, 1153, "Special AI:");
    GFTextEntry(gump, 200, 410, 300, 20, 1150, form_data.special_ai, 6);
    
    // NPC Profile Section
    GFTextMid(gump, 0, 450, gump_width, 1153, "NPC PROFILE");
    
    // URL for image
    GFTextLine(gump, 50, 480, 1153, "Image URL (200x200):");
    GFTextEntry(gump, 200, 480, 400, 20, 1150, form_data.url, 7);
    
    // Detailed Description
    GFTextLine(gump, 50, 510, 1153, "Detailed Description:");
    GFTextEntry(gump, 200, 510, 400, 100, 1150, form_data.detailed_description, 8);
    
    // Add Create Boss button at the bottom
    GFAddButton(gump, gump_width/2 - 80, gump_height - 50, 2128, 2129, 1, 100);
    GFTextLine(gump, gump_width/2 - 40, gump_height - 45, 1153, "CREATE BOSS");
    
    // Send the gump to the player
    var input := GFSendGump(who, gump);
    return input;
endfunction

function ShowPage2(who, title, gump_width, gump_height)
    var gump := GFECreateGump(title, gump_width, gump_height);
    
    // Add navigation buttons
    AddNavigationButtons(gump, gump_width);
    
    // Page 2 content - ATTRIBUTES
    GFTextMid(gump, 0, 150, gump_width, 1153, "ATTRIBUTES & STATS");
    
    // Stats section
    GFTextMid(gump, 0, 180, gump_width, 1153, "Base Stats");
    
    // Strength
    GFTextLine(gump, 50, 210, 1153, "Strength Modifier:");
    GFTextEntry(gump, 200, 210, 100, 20, 1150, form_data.str, 10);
    
    // Dexterity
    GFTextLine(gump, 50, 240, 1153, "Dexterity Modifier:");
    GFTextEntry(gump, 200, 240, 100, 20, 1150, form_data.dex, 11);
    
    // Intelligence
    GFTextLine(gump, 50, 270, 1153, "Intelligence Modifier:");
    GFTextEntry(gump, 200, 270, 100, 20, 1150, form_data.int, 12);
    
    // Hits
    GFTextLine(gump, 50, 300, 1153, "Hits Modifier:");
    GFTextEntry(gump, 200, 300, 100, 20, 1150, form_data.hits, 13);
    
    // Damage Modifier
    GFTextLine(gump, 50, 330, 1153, "Damage Modifier (0.1-1.0):");
    GFTextEntry(gump, 250, 330, 100, 20, 1150, form_data.dmg, 14);
    
    // Resistances section
    GFTextMid(gump, 0, 370, gump_width, 1153, "Resistances");
    
    // Physical
    GFTextLine(gump, 600, 210, 1153, "Physical:");
    GFTextEntry(gump, 700, 210, 100, 20, 1150, form_data.phresist, 15);
    
    // Fire
    GFTextLine(gump, 600, 240, 1153, "Fire:");
    GFTextEntry(gump, 700, 240, 100, 20, 1150, form_data.firesist, 16);
    
    // Cold
    GFTextLine(gump, 600, 270, 1153, "Cold:");
    GFTextEntry(gump, 700, 270, 100, 20, 1150, form_data.coresist, 17);
    
    // Energy
    GFTextLine(gump, 600, 300, 1153, "Energy:");
    GFTextEntry(gump, 700, 300, 100, 20, 1150, form_data.enresist, 18);
    
    // Poison
    GFTextLine(gump, 600, 330, 1153, "Poison:");
    GFTextEntry(gump, 700, 330, 100, 20, 1150, form_data.poresist, 19);
    
    // Skills section
    GFTextMid(gump, 0, 400, gump_width, 1153, "Skills");
    
    // Wrestling
    GFTextLine(gump, 50, 430, 1153, "Wrestling Modifier:");
    GFTextEntry(gump, 200, 430, 100, 20, 1150, form_data.wrestling, 20);
    
    // Tactics
    GFTextLine(gump, 50, 460, 1153, "Tactics Modifier:");
    GFTextEntry(gump, 200, 460, 100, 20, 1150, form_data.tactics, 21);
    
    // Magery
    GFTextLine(gump, 50, 490, 1153, "Magery Modifier:");
    GFTextEntry(gump, 200, 490, 100, 20, 1150, form_data.magery, 22);
    
    // Awareness
    GFTextLine(gump, 50, 520, 1153, "Awareness Modifier:");
    GFTextEntry(gump, 200, 520, 100, 20, 1150, form_data.awareness, 23);
    
    // Add Create Boss button at the bottom
    GFAddButton(gump, gump_width/2 - 80, gump_height - 50, 2128, 2129, 1, 100);
    GFTextLine(gump, gump_width/2 - 40, gump_height - 45, 1153, "CREATE BOSS");
    
    // Send the gump to the player
    var input := GFSendGump(who, gump);
    return input;
endfunction

function ShowPage3(who, title, gump_width, gump_height)
    var gump := GFECreateGump(title, gump_width, gump_height);
    
    // Add navigation buttons
    AddNavigationButtons(gump, gump_width);
    
    // Page 3 content - ABILITIES
    GFTextMid(gump, 0, 150, gump_width, 1153, "SPECIAL ABILITIES");
    
    // Special Abilities section
    GFTextLine(gump, 50, 180, 1153, "Special Abilities:");
    GFAddButton(gump, 250, 180, 2103, 2104, 1, 30);
    GFTextLine(gump, 280, 180, 1153, "Add Special Ability");
    
    // List of available abilities
    GFTextLine(gump, 50, 210, 1153, "Available Abilities:");
    GFTextLine(gump, 80, 230, 1153, "- Ice Hit");
    GFTextLine(gump, 80, 250, 1153, "- Fire Hit");
    GFTextLine(gump, 80, 270, 1153, "- Energy Hit");
    GFTextLine(gump, 80, 290, 1153, "- Life Drain");
    GFTextLine(gump, 80, 310, 1153, "- Damage Return");
    GFTextLine(gump, 80, 330, 1153, "- Custom Hit Script");
    
    // Combat Events section
    GFTextLine(gump, 600, 180, 1153, "Combat Events:");
    GFAddButton(gump, 800, 180, 2103, 2104, 1, 40);
    GFTextLine(gump, 830, 180, 1153, "Add Combat Event");
    
    // TimedScripts section
    GFTextLine(gump, 50, 370, 1153, "TimedScripts:");
    GFAddButton(gump, 250, 370, 2103, 2104, 1, 50);
    GFTextLine(gump, 280, 370, 1153, "Add TimedScript");
    
    // List of available timedscripts
    GFTextLine(gump, 80, 400, 1153, "- Poison");
    GFTextLine(gump, 80, 420, 1153, "- Paralysis");
    GFTextLine(gump, 80, 440, 1153, "- Clumsy");
    GFTextLine(gump, 80, 460, 1153, "- Weaken");
    GFTextLine(gump, 80, 480, 1153, "- Bleed");
    
    // Death Events section
    GFTextLine(gump, 600, 370, 1153, "Death Events:");
    GFAddButton(gump, 800, 370, 2103, 2104, 1, 60);
    GFTextLine(gump, 830, 370, 1153, "Add Death Event");
    
    // Add Create Boss button at the bottom
    GFAddButton(gump, gump_width/2 - 80, gump_height - 50, 2128, 2129, 1, 100);
    GFTextLine(gump, gump_width/2 - 40, gump_height - 45, 1153, "CREATE BOSS");
    
    // Send the gump to the player
    var input := GFSendGump(who, gump);
    return input;
endfunction

function ShowPage4(who, title, gump_width, gump_height)
    var gump := GFECreateGump(title, gump_width, gump_height);
    
    // Add navigation buttons
    AddNavigationButtons(gump, gump_width);
    
    // Page 4 content - BEHAVIOR
    GFTextMid(gump, 0, 150, gump_width, 1153, "BEHAVIOR & MOVEMENT");
    
    // Patrol Areas section
    GFTextLine(gump, 50, 180, 1153, "Patrol Areas:");
    GFAddButton(gump, 250, 180, 2103, 2104, 1, 70);
    GFTextLine(gump, 280, 180, 1153, "Set Patrol Location 1");
    
    GFAddButton(gump, 250, 210, 2103, 2104, 1, 71);
    GFTextLine(gump, 280, 210, 1153, "Set Patrol Location 2");
    
    // Teleport Conditions section
    GFTextLine(gump, 50, 250, 1153, "Teleport When Health Below:");
    GFTextEntry(gump, 250, 250, 100, 20, 1150, form_data.teleport_health ? form_data.teleport_health : "25", 72);
    GFTextLine(gump, 360, 250, 1153, "%");
    
    GFAddButton(gump, 250, 280, 2103, 2104, 1, 73);
    GFTextLine(gump, 280, 280, 1153, "Set Teleport Location");
    
    // Ability Conditions section
    GFTextLine(gump, 50, 320, 1153, "Ability Conditions:");
    GFAddButton(gump, 250, 320, 2103, 2104, 1, 74);
    GFTextLine(gump, 280, 320, 1153, "Add Ability Condition");
    
    // Examples of conditions
    GFTextLine(gump, 80, 350, 1153, "Examples:");
    GFTextLine(gump, 80, 370, 1153, "- Use ability when health below X%");
    GFTextLine(gump, 80, 390, 1153, "- Use ability when X players are nearby");
    GFTextLine(gump, 80, 410, 1153, "- Use ability every X seconds");
    
    // AI Settings section
    GFTextLine(gump, 600, 180, 1153, "AI Settings:");
    
    // Aggression Level
    GFTextLine(gump, 600, 210, 1153, "Aggression Level:");
    GFAddButton(gump, 730, 210, 2103, 2104, 1, 75);
    GFTextLine(gump, 760, 210, 1153, form_data.aggression ? form_data.aggression : "High");
    
    // Flee Level
    GFTextLine(gump, 600, 240, 1153, "Flee When Health Below:");
    GFTextEntry(gump, 780, 240, 100, 20, 1150, form_data.flee_health ? form_data.flee_health : "10", 76);
    GFTextLine(gump, 890, 240, 1153, "%");
    
    // Target Selection
    GFTextLine(gump, 600, 270, 1153, "Target Selection:");
    GFAddButton(gump, 730, 270, 2103, 2104, 1, 77);
    GFTextLine(gump, 760, 270, 1153, form_data.target_selection ? form_data.target_selection : "Highest Damage");
    
    // Add Create Boss button at the bottom
    GFAddButton(gump, gump_width/2 - 80, gump_height - 50, 2128, 2129, 1, 100);
    GFTextLine(gump, gump_width/2 - 40, gump_height - 45, 1153, "CREATE BOSS");
    
    // Send the gump to the player
    var input := GFSendGump(who, gump);
    return input;
endfunction

function ShowPage5(who, title, gump_width, gump_height)
    var gump := GFECreateGump(title, gump_width, gump_height);
    
    // Add navigation buttons
    AddNavigationButtons(gump, gump_width);
    
    // Page 5 content - EQUIPMENT
    GFTextMid(gump, 0, 150, gump_width, 1153, "EQUIPMENT & LOOT");
    
    // Weapon Selection section
    GFTextLine(gump, 50, 180, 1153, "Weapon Type:");
    
    // Weapon type radio buttons
    GFAddButton(gump, 50, 210, 2151, 2153, 1, 80);
    GFTextLine(gump, 80, 210, 1153, "Dual Wield");
    
    GFAddButton(gump, 50, 240, 2151, 2153, 1, 81);
    GFTextLine(gump, 80, 240, 1153, "One-Handed");
    
    GFAddButton(gump, 50, 270, 2151, 2153, 1, 82);
    GFTextLine(gump, 80, 270, 1153, "Two-Handed");
    
    GFAddButton(gump, 50, 300, 2151, 2153, 1, 83);
    GFTextLine(gump, 80, 300, 1153, "Ranged");
    
    // Specific weapon
    GFTextLine(gump, 50, 340, 1153, "Specific Weapon (ID or Name):");
    GFTextEntry(gump, 250, 340, 200, 20, 1150, form_data.specific_weapon ? form_data.specific_weapon : "", 84);
    
    // Class Selection (for humanoid)
    GFTextLine(gump, 50, 380, 1153, "Class (for Humanoid):");
    
    // Class type radio buttons
    GFAddButton(gump, 50, 410, 2151, 2153, 1, 85);
    GFTextLine(gump, 80, 410, 1153, "Warrior");
    
    GFAddButton(gump, 50, 440, 2151, 2153, 1, 86);
    GFTextLine(gump, 80, 440, 1153, "Mage");
    
    GFAddButton(gump, 50, 470, 2151, 2153, 1, 87);
    GFTextLine(gump, 80, 470, 1153, "Ranger");
    
    // Magic School (for mage)
    GFTextLine(gump, 50, 510, 1153, "Magic School:");
    GFTextEntry(gump, 250, 510, 200, 20, 1150, form_data.magic_school ? form_data.magic_school : "", 88);
    
    // Loot section
    GFTextLine(gump, 600, 180, 1153, "Loot Items:");
    GFAddButton(gump, 800, 180, 2103, 2104, 1, 90);
    GFTextLine(gump, 830, 180, 1153, "Add Loot Item");
    
    // Loot chance
    GFTextLine(gump, 600, 210, 1153, "Default Drop Chance (%):");
    GFTextEntry(gump, 800, 210, 100, 20, 1150, form_data.drop_chance ? form_data.drop_chance : "25", 91);
    
    // Add Create Boss button at the bottom
    GFAddButton(gump, gump_width/2 - 80, gump_height - 50, 2128, 2129, 1, 100);
    GFTextLine(gump, gump_width/2 - 40, gump_height - 45, 1153, "CREATE BOSS");
    
    // Send the gump to the player
    var input := GFSendGump(who, gump);
    return input;
endfunction

// Add a function to create the boss from form data
function CreateBossFromGump(who, form_data)
    // Create a boss structure
    var boss := struct{};
    
    // Initialize arrays
    boss.special := array{};
    boss.loot := array{};
    boss.deathevent := array{};
    
    // Basic info
    boss.npctemplate := form_data.npctemplate;
    boss.name := form_data.name;
    boss.color := CInt(form_data.color);
    boss.description := form_data.description;
    boss.trueboss := form_data.trueboss;
    
    // Special AI
    if (form_data.special_ai != "")
        var ai_spec := struct{};
        ai_spec.name := "Special AI";
        ai_spec.ai := form_data.special_ai;
        boss.special.append(ai_spec);
    endif
    
    // NPC Profile
    boss.url := form_data.url;
    boss.detailed_description := form_data.detailed_description;
    
    // Attributes
    boss.str := CInt(form_data.str);
    boss.dex := CInt(form_data.dex);
    boss.int := CInt(form_data.int);
    boss.hits := CInt(form_data.hits);
    boss.dmg := CDbl(form_data.dmg);
    
    // Resistances
    boss.phresist := CInt(form_data.phresist);
    boss.firesist := CInt(form_data.firesist);
    boss.coresist := CInt(form_data.coresist);
    boss.enresist := CInt(form_data.enresist);
    boss.poresist := CInt(form_data.poresist);
    
    // Skills
    boss.wrestling := CInt(form_data.wrestling);
    boss.tactics := CInt(form_data.tactics);
    boss.magery := CInt(form_data.magery);
    boss.awareness := CInt(form_data.awareness);
    
    SendSysMessage(who, "Creating boss...");
    
    // Create a test boss to show the player
    var npc := CreateEpicBoss(boss, who.x, who.y, who.z, who.realm);
    if (npc == error)
        SendSysMessage(who, "Error creating boss: " + npc.errortext);
        return 0;
    endif
    
    // Create a spawner for this boss
    var spawner := CreateItemAtLocation(who.x, who.y, who.z, 0xA402, 1, who.realm);
    if (spawner)
        // Set the boss structure in the spawner
        SetObjProperty(spawner, "BossStruct", boss);
        
        // Set default spawn settings
        SetObjProperty(spawner, "MinDelay", 60);  // 60 minutes
        SetObjProperty(spawner, "MaxDelay", 120); // 120 minutes
        SetObjProperty(spawner, "Range", 5);      // 5 tiles
        
        // Link the test boss to the spawner
        SetObjProperty(npc, "epicspawner", spawner.serial);
        SetObjProperty(spawner, "ChildSerial", npc.serial);
        SetObjProperty(spawner, "SpawnQueue", "Active");
        
        spawner.invisible := 1;
        
        SendSysMessage(who, "Boss created successfully with spawner!");
        SendSysMessage(who, "The boss will respawn between 60-120 minutes after death.");
        SendSysMessage(who, "Double-click the spawner (invisible at your feet) to configure.");
    else
        SendSysMessage(who, "Boss created successfully, but failed to create spawner!");
    endif
    
    return 1;
endfunction
