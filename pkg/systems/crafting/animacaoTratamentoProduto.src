use uo;
use os;
use cfgfile;

include "/include/epicPropNames";
include "/include/epicConstants";
include ":crafting:/include/animacaoTratamentoProduto";
include ":megacliloc:/include/toolTipUtils";
include ":crafting:/include/tratamentoProduto";


program AnimacaoTratamentoProduto(parametros)
	var quem			:= parametros[1];
	var produto			:= parametros[2];
	var pidGerente 		:= parametros[3];
	var estacaoAlvo 	:= parametros[4];
	
	var propFabricado := GetObjProperty(produto,PROPNAME_FABRICADO);
	var estacao;
	var itemDescGeral := ReadConfigFile(":*:itemdesc");
	var processoGerente := GetProcess(pidGerente);
	
	var isAlvoValido := isEstacaoValida(quem,estacaoAlvo,propFabricado.receita.profissao);
	
	if(propFabricado.receita.profissao == "Blacksmithy" && isAlvoValido)
		estacao := PegaEstacaoFerreiro(quem, estacaoAlvo.item);
	else
		estacao := estacaoAlvo;
	endif

	var deveSair := !(estacao && isAlvoValido);

	while(!deveSair)

		if(processoGerente.state)
			case (propFabricado.receita.profissao)
				"Blacksmithy":
					var produtoElemConfig := itemDescGeral[propFabricado.receita.objtype];
					var classificacaoProduto := ClassificaParametro(produtoElemConfig);
					if(classificacaoProduto != DESCONHECIDO)
						devesair := RodaAnimacaoFerreiro(quem,produto,estacao,processoGerente, classificacaoProduto);
					endif
					break;
				default:
					devesair := RodaAnimacaoPadrao(quem,produto,estacao,processoGerente,propFabricado);

			endcase
		else
			deveSair := true;
		endif
	endwhile

	if(processoGerente.state)
		processoGerente.sendEvent(struct {id := EV_CANCELADO});
	endif
endprogram
